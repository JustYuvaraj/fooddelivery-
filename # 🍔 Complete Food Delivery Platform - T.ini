# ğŸ” Complete Food Delivery Platform - Technical Documentation

**Version:** 1.0.0  
**Last Updated:** December 2025  
**Tech Stack:** React 18, Spring Boot 3.2, PostgreSQL 15, Redis 7, WebSocket

---

## ğŸ“‹ Table of Contents

1. [System Overview](#1-system-overview)
2. [Architecture Design](#2-architecture-design)
3. [Database Design](#3-database-design)
4. [Backend Implementation](#4-backend-implementation)
5. [Frontend Implementation](#5-frontend-implementation)
6. [Security & Authentication](#6-security--authentication)
7. [Real-Time Features](#7-real-time-features)
8. [API Reference](#8-api-reference)
9. [Deployment Guide](#9-deployment-guide)
10. [Testing Strategy](#10-testing-strategy)

---

## 1. System Overview

### 1.1 Business Requirements

**Platform Purpose:** Multi-sided marketplace connecting customers, restaurants, and delivery agents.

**Core Features:**
- Customer: Browse restaurants, place orders, track delivery in real-time
- Restaurant: Manage menu, accept/prepare orders, update status
- Delivery Agent: Accept delivery tasks, navigate to locations, complete deliveries
- Admin: Monitor all operations, manage users, view analytics

### 1.2 User Roles

| Role | Access Level | Key Actions |
|------|-------------|-------------|
| **CUSTOMER** | Public + Personal Data | Browse, Order, Track, Review |
| **RESTAURANT_OWNER** | Restaurant Data | Menu Management, Order Processing |
| **DELIVERY_AGENT** | Assigned Orders | Accept Tasks, Update Location, Complete Delivery |
| **ADMIN** | Full System Access | User Management, Analytics, System Config |

### 1.3 System Capabilities

- **Concurrent Users:** 10,000+ simultaneous connections
- **Order Processing:** 1,000+ orders/hour
- **Real-Time Tracking:** <1 second latency for location updates
- **Search Performance:** <200ms for restaurant/menu queries
- **Availability:** 99.9% uptime SLA

---

## 2. Architecture Design

### 2.1 High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       CLIENT LAYER                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Customer   â”‚  â”‚  Restaurant  â”‚  â”‚   Delivery   â”‚     â”‚
â”‚  â”‚   Web App    â”‚  â”‚   Dashboard  â”‚  â”‚   Mobile App â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚ HTTPS / WebSocket
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API GATEWAY (Nginx)                      â”‚
â”‚              SSL Termination â€¢ Rate Limiting                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              SPRING BOOT APPLICATION LAYER                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚  Order   â”‚ â”‚ Delivery â”‚ â”‚   User   â”‚ â”‚ Payment  â”‚      â”‚
â”‚  â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚ â”‚ Service  â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATA LAYER                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  PostgreSQL  â”‚  â”‚    Redis     â”‚  â”‚  S3 Storage  â”‚     â”‚
â”‚  â”‚   (Primary)  â”‚  â”‚   (Cache)    â”‚  â”‚   (Images)   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Component Interaction Flow

**Order Placement Flow:**
```
Customer â†’ React UI â†’ API Gateway â†’ Order Service â†’ PostgreSQL
                                   â†’ Event Publisher â†’ WebSocket Server
                                   â†’ Restaurant Dashboard (Real-time update)
```

**Delivery Assignment Flow:**
```
Restaurant (Ready) â†’ Status Update â†’ Event Trigger â†’ Delivery Service
                                                    â†“
                                    Geo-query (Find nearby agents)
                                                    â†“
                                    Push Notification â†’ Agent #1, #2, #3
                                                    â†“
                                    First Accept â†’ Assignment Created
                                                    â†“
                                    Customer Notified (WebSocket)
```

### 2.3 Design Patterns Used

1. **Repository Pattern:** Data access abstraction
2. **Service Layer Pattern:** Business logic separation
3. **DTO Pattern:** API contract management
4. **Event-Driven Pattern:** Decoupled communication
5. **Strategy Pattern:** Payment gateway switching
6. **Factory Pattern:** Notification channel creation

---

## 3. Database Design

### 3.1 Entity Relationship Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    users    â”‚         â”‚ restaurants â”‚         â”‚  products   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)     â”‚â”€â”€â”€â”€â”    â”‚ id (PK)     â”‚â”€â”€â”€â”€â”    â”‚ id (PK)     â”‚
â”‚ email       â”‚    â”‚    â”‚ name        â”‚    â”‚    â”‚ name        â”‚
â”‚ password    â”‚    â”‚    â”‚ owner_id(FK)â”‚â”€â”€â”€â”€â”˜    â”‚ price       â”‚
â”‚ role (ENUM) â”‚    â”‚    â”‚ address     â”‚         â”‚ restaurant  â”‚
â”‚ phone       â”‚    â”‚    â”‚ lat, lng    â”‚         â”‚   _id (FK)  â”‚
â”‚ created_at  â”‚    â”‚    â”‚ is_active   â”‚         â”‚ is_availableâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚    â”‚ rating      â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚                         â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                   â”‚    orders    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”¤  order_items   â”‚
                   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                   â”‚ id (PK)      â”‚         â”‚ id (PK)        â”‚
                   â”‚ customer_id  â”‚         â”‚ order_id (FK)  â”‚
                   â”‚   (FK)       â”‚         â”‚ product_id(FK) â”‚
                   â”‚ restaurant_idâ”‚         â”‚ quantity       â”‚
                   â”‚ delivery_id  â”‚         â”‚ price_snapshot â”‚
                   â”‚   (FK, NULL) â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ status (ENUM)â”‚
                   â”‚ total_amount â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚ delivery_fee â”‚         â”‚ delivery_      â”‚
                   â”‚ created_at   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  assignments   â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                            â”‚               â”‚ id (PK)        â”‚
                            â”‚               â”‚ order_id (FK)  â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ agent_id (FK)  â”‚
                                            â”‚ assigned_at    â”‚
                                            â”‚ accepted_at    â”‚
                                            â”‚ picked_up_at   â”‚
                                            â”‚ delivered_at   â”‚
                                            â”‚ status (ENUM)  â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 Complete SQL Schema

```sql
-- ============================================
-- USERS TABLE
-- ============================================
CREATE TYPE user_role AS ENUM ('CUSTOMER', 'RESTAURANT_OWNER', 'DELIVERY_AGENT', 'ADMIN');

CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role user_role NOT NULL,
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100),
    phone VARCHAR(20) NOT NULL,
    profile_image_url VARCHAR(500),
    is_active BOOLEAN DEFAULT true,
    is_verified BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_phone ON users(phone);

-- ============================================
-- USER ADDRESSES TABLE
-- ============================================
CREATE TABLE user_addresses (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    label VARCHAR(50), -- 'Home', 'Work', 'Other'
    address_line1 VARCHAR(255) NOT NULL,
    address_line2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100) NOT NULL,
    postal_code VARCHAR(20) NOT NULL,
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    is_default BOOLEAN DEFAULT false,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_addresses_user ON user_addresses(user_id);
CREATE INDEX idx_addresses_location ON user_addresses USING GIST(
    ll_to_earth(latitude, longitude)
);

-- ============================================
-- RESTAURANTS TABLE
-- ============================================
CREATE TABLE restaurants (
    id BIGSERIAL PRIMARY KEY,
    owner_id BIGINT NOT NULL REFERENCES users(id),
    name VARCHAR(255) NOT NULL,
    description TEXT,
    cuisine_type VARCHAR(100),
    address VARCHAR(500) NOT NULL,
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    email VARCHAR(255),
    opening_time TIME NOT NULL,
    closing_time TIME NOT NULL,
    prep_time_mins INTEGER DEFAULT 30,
    min_order_amount DECIMAL(10, 2) DEFAULT 0,
    delivery_radius_km DECIMAL(5, 2) DEFAULT 5.0,
    rating DECIMAL(3, 2) DEFAULT 0.0,
    total_reviews INTEGER DEFAULT 0,
    is_active BOOLEAN DEFAULT true,
    is_accepting_orders BOOLEAN DEFAULT true,
    logo_url VARCHAR(500),
    banner_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_restaurants_owner ON restaurants(owner_id);
CREATE INDEX idx_restaurants_active ON restaurants(is_active, is_accepting_orders);
CREATE INDEX idx_restaurants_location ON restaurants USING GIST(
    ll_to_earth(latitude, longitude)
);

-- ============================================
-- PRODUCTS (MENU ITEMS) TABLE
-- ============================================
CREATE TABLE products (
    id BIGSERIAL PRIMARY KEY,
    restaurant_id BIGINT NOT NULL REFERENCES restaurants(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    category VARCHAR(100), -- 'Appetizer', 'Main Course', 'Dessert', 'Beverage'
    price DECIMAL(10, 2) NOT NULL CHECK (price >= 0),
    image_url VARCHAR(500),
    is_veg BOOLEAN DEFAULT false,
    is_available BOOLEAN DEFAULT true,
    prep_time_mins INTEGER DEFAULT 15,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_products_restaurant ON products(restaurant_id);
CREATE INDEX idx_products_available ON products(is_available);
CREATE INDEX idx_products_category ON products(category);

-- ============================================
-- ORDERS TABLE
-- ============================================
CREATE TYPE order_status AS ENUM (
    'PLACED',           -- Customer placed order
    'CONFIRMED',        -- Restaurant confirmed
    'PREPARING',        -- Kitchen is preparing
    'READY',            -- Ready for pickup
    'ASSIGNED',         -- Delivery agent assigned
    'PICKED_UP',        -- Agent picked up order
    'OUT_FOR_DELIVERY', -- On the way
    'DELIVERED',        -- Successfully delivered
    'CANCELLED'         -- Order cancelled
);

CREATE TABLE orders (
    id BIGSERIAL PRIMARY KEY,
    order_number VARCHAR(50) UNIQUE NOT NULL, -- Human-readable: ORD-20250104-1234
    customer_id BIGINT NOT NULL REFERENCES users(id),
    restaurant_id BIGINT NOT NULL REFERENCES restaurants(id),
    delivery_agent_id BIGINT REFERENCES users(id),
    
    -- Address Details
    delivery_address_id BIGINT REFERENCES user_addresses(id),
    delivery_latitude DECIMAL(10, 8) NOT NULL,
    delivery_longitude DECIMAL(11, 8) NOT NULL,
    
    -- Order Details
    status order_status DEFAULT 'PLACED' NOT NULL,
    items_total DECIMAL(10, 2) NOT NULL,
    delivery_fee DECIMAL(10, 2) DEFAULT 0,
    tax_amount DECIMAL(10, 2) DEFAULT 0,
    discount_amount DECIMAL(10, 2) DEFAULT 0,
    total_amount DECIMAL(10, 2) NOT NULL,
    
    -- Timestamps
    placed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    confirmed_at TIMESTAMP,
    ready_at TIMESTAMP,
    picked_up_at TIMESTAMP,
    delivered_at TIMESTAMP,
    cancelled_at TIMESTAMP,
    
    -- Additional Info
    special_instructions TEXT,
    cancellation_reason TEXT,
    estimated_delivery_time TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_orders_customer ON orders(customer_id, status);
CREATE INDEX idx_orders_restaurant ON orders(restaurant_id, status);
CREATE INDEX idx_orders_delivery ON orders(delivery_agent_id, status);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_date ON orders(placed_at);

-- ============================================
-- ORDER ITEMS TABLE
-- ============================================
CREATE TABLE order_items (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    product_id BIGINT NOT NULL REFERENCES products(id),
    product_name VARCHAR(255) NOT NULL, -- Snapshot at order time
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(10, 2) NOT NULL,
    subtotal DECIMAL(10, 2) NOT NULL,
    special_requests TEXT
);

CREATE INDEX idx_order_items_order ON order_items(order_id);

-- ============================================
-- DELIVERY ASSIGNMENTS TABLE
-- ============================================
CREATE TYPE assignment_status AS ENUM (
    'PENDING',    -- Sent to agent, awaiting acceptance
    'ACCEPTED',   -- Agent accepted
    'REJECTED',   -- Agent rejected
    'COMPLETED',  -- Delivery completed
    'CANCELLED'   -- Assignment cancelled
);

CREATE TABLE delivery_assignments (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id),
    delivery_agent_id BIGINT NOT NULL REFERENCES users(id),
    status assignment_status DEFAULT 'PENDING',
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    accepted_at TIMESTAMP,
    rejected_at TIMESTAMP,
    picked_up_at TIMESTAMP,
    delivered_at TIMESTAMP,
    rejection_reason TEXT,
    agent_rating INTEGER CHECK (agent_rating BETWEEN 1 AND 5),
    agent_feedback TEXT
);

CREATE INDEX idx_assignments_order ON delivery_assignments(order_id);
CREATE INDEX idx_assignments_agent ON delivery_assignments(delivery_agent_id, status);

-- ============================================
-- ORDER STATUS HISTORY (AUDIT TRAIL)
-- ============================================
CREATE TABLE order_status_history (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id) ON DELETE CASCADE,
    from_status order_status,
    to_status order_status NOT NULL,
    changed_by_user_id BIGINT REFERENCES users(id),
    notes TEXT,
    changed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_status_history_order ON order_status_history(order_id);

-- ============================================
-- AGENT LOCATION TRACKING
-- ============================================
CREATE TABLE agent_locations (
    id BIGSERIAL PRIMARY KEY,
    agent_id BIGINT NOT NULL REFERENCES users(id),
    latitude DECIMAL(10, 8) NOT NULL,
    longitude DECIMAL(11, 8) NOT NULL,
    accuracy_meters DECIMAL(8, 2),
    is_online BOOLEAN DEFAULT true,
    recorded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_agent_locations_agent ON agent_locations(agent_id);
CREATE INDEX idx_agent_locations_time ON agent_locations(recorded_at);
CREATE INDEX idx_agent_locations_geo ON agent_locations USING GIST(
    ll_to_earth(latitude, longitude)
);

-- ============================================
-- NOTIFICATIONS TABLE
-- ============================================
CREATE TYPE notification_type AS ENUM (
    'ORDER_PLACED',
    'ORDER_CONFIRMED',
    'ORDER_READY',
    'DELIVERY_ASSIGNED',
    'OUT_FOR_DELIVERY',
    'DELIVERED',
    'ORDER_CANCELLED',
    'PAYMENT_SUCCESS',
    'PROMOTION'
);

CREATE TABLE notifications (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    type notification_type NOT NULL,
    title VARCHAR(255) NOT NULL,
    message TEXT NOT NULL,
    data JSONB, -- Additional payload
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notifications_user ON notifications(user_id, is_read);
CREATE INDEX idx_notifications_created ON notifications(created_at);

-- ============================================
-- REVIEWS TABLE
-- ============================================
CREATE TABLE reviews (
    id BIGSERIAL PRIMARY KEY,
    order_id BIGINT NOT NULL REFERENCES orders(id),
    customer_id BIGINT NOT NULL REFERENCES users(id),
    restaurant_id BIGINT NOT NULL REFERENCES restaurants(id),
    delivery_agent_id BIGINT REFERENCES users(id),
    
    food_rating INTEGER CHECK (food_rating BETWEEN 1 AND 5),
    delivery_rating INTEGER CHECK (delivery_rating BETWEEN 1 AND 5),
    
    comment TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_reviews_restaurant ON reviews(restaurant_id);
CREATE INDEX idx_reviews_agent ON reviews(delivery_agent_id);

-- ============================================
-- TRIGGERS
-- ============================================

-- Auto-update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_restaurants_updated_at BEFORE UPDATE ON restaurants
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_products_updated_at BEFORE UPDATE ON products
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_orders_updated_at BEFORE UPDATE ON orders
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### 3.3 Sample Data Seeds

```sql
-- Insert sample users
INSERT INTO users (email, password_hash, role, first_name, last_name, phone) VALUES
('customer@test.com', '$2a$10$...', 'CUSTOMER', 'John', 'Doe', '+919876543210'),
('restaurant@test.com', '$2a$10$...', 'RESTAURANT_OWNER', 'Jane', 'Smith', '+919876543211'),
('delivery@test.com', '$2a$10$...', 'DELIVERY_AGENT', 'Mike', 'Wilson', '+919876543212'),
('admin@test.com', '$2a$10$...', 'ADMIN', 'Admin', 'User', '+919876543213');

-- Insert sample restaurant
INSERT INTO restaurants (owner_id, name, description, cuisine_type, address, latitude, longitude, phone, opening_time, closing_time) 
VALUES (2, 'Pizza Paradise', 'Best pizzas in town', 'Italian', '123 Main St', 28.6139, 77.2090, '+919876543214', '10:00:00', '23:00:00');
```

---

## 4. Backend Implementation

### 4.1 Project Structure

```
food-delivery-backend/
â”œâ”€â”€ src/main/java/com/fooddelivery/
â”‚   â”œâ”€â”€ FoodDeliveryApplication.java
â”‚   â”œâ”€â”€ config/
â”‚   â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”‚   â”œâ”€â”€ WebSocketConfig.java
â”‚   â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â”‚   â””â”€â”€ CorsConfig.java
â”‚   â”œâ”€â”€ controller/
â”‚   â”‚   â”œâ”€â”€ AuthController.java
â”‚   â”‚   â”œâ”€â”€ OrderController.java
â”‚   â”‚   â”œâ”€â”€ RestaurantController.java
â”‚   â”‚   â”œâ”€â”€ DeliveryController.java
â”‚   â”‚   â””â”€â”€ AdminController.java
â”‚   â”œâ”€â”€ service/
â”‚   â”‚   â”œâ”€â”€ AuthService.java
â”‚   â”‚   â”œâ”€â”€ OrderService.java
â”‚   â”‚   â”œâ”€â”€ DeliveryAssignmentService.java
â”‚   â”‚   â”œâ”€â”€ NotificationService.java
â”‚   â”‚   â””â”€â”€ LocationTrackingService.java
â”‚   â”œâ”€â”€ repository/
â”‚   â”‚   â”œâ”€â”€ UserRepository.java
â”‚   â”‚   â”œâ”€â”€ OrderRepository.java
â”‚   â”‚   â”œâ”€â”€ RestaurantRepository.java
â”‚   â”‚   â””â”€â”€ DeliveryAssignmentRepository.java
â”‚   â”œâ”€â”€ model/
â”‚   â”‚   â”œâ”€â”€ entity/
â”‚   â”‚   â”‚   â”œâ”€â”€ User.java
â”‚   â”‚   â”‚   â”œâ”€â”€ Order.java
â”‚   â”‚   â”‚   â”œâ”€â”€ Restaurant.java
â”‚   â”‚   â”‚   â””â”€â”€ Product.java
â”‚   â”‚   â””â”€â”€ enums/
â”‚   â”‚       â”œâ”€â”€ UserRole.java
â”‚   â”‚       â”œâ”€â”€ OrderStatus.java
â”‚   â”‚       â””â”€â”€ AssignmentStatus.java
â”‚   â”œâ”€â”€ dto/
â”‚   â”‚   â”œâ”€â”€ request/
â”‚   â”‚   â”‚   â”œâ”€â”€ LoginRequest.java
â”‚   â”‚   â”‚   â”œâ”€â”€ CreateOrderRequest.java
â”‚   â”‚   â”‚   â””â”€â”€ UpdateLocationRequest.java
â”‚   â”‚   â””â”€â”€ response/
â”‚   â”‚       â”œâ”€â”€ AuthResponse.java
â”‚   â”‚       â”œâ”€â”€ OrderDTO.java
â”‚   â”‚       â””â”€â”€ RestaurantDTO.java
â”‚   â”œâ”€â”€ security/
â”‚   â”‚   â”œâ”€â”€ JwtTokenProvider.java
â”‚   â”‚   â”œâ”€â”€ JwtAuthenticationFilter.java
â”‚   â”‚   â””â”€â”€ UserDetailsServiceImpl.java
â”‚   â”œâ”€â”€ exception/
â”‚   â”‚   â”œâ”€â”€ GlobalExceptionHandler.java
â”‚   â”‚   â”œâ”€â”€ OrderNotFoundException.java
â”‚   â”‚   â””â”€â”€ UnauthorizedAccessException.java
â”‚   â”œâ”€â”€ event/
â”‚   â”‚   â”œâ”€â”€ OrderStatusChangedEvent.java
â”‚   â”‚   â””â”€â”€ OrderEventListener.java
â”‚   â””â”€â”€ util/
â”‚       â”œâ”€â”€ GeoUtils.java
â”‚       â””â”€â”€ ResponseUtil.java
â”œâ”€â”€ src/main/resources/
â”‚   â”œâ”€â”€ application.yml
â”‚   â””â”€â”€ application-prod.yml
â””â”€â”€ pom.xml
```

### 4.2 Core Entity Classes

```java
// User.java
@Entity
@Table(name = "users")
public class User {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String email;
    
    @Column(nullable = false)
    private String passwordHash;
    
    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole role;
    
    private String firstName;
    private String lastName;
    private String phone;
    private String profileImageUrl;
    private Boolean isActive = true;
    private Boolean isVerified = false;
    
    @CreationTimestamp
    private LocalDateTime createdAt;
    
    @UpdateTimestamp
    private LocalDateTime updatedAt;
    
    // Getters, setters, constructors
}

// Order.java
@Entity
@Table(name = "orders")
public class Order {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;
    
    @Column(unique = true, nullable = false)
    private String orderNumber;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "customer_id", nullable = false)
    private User customer;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "restaurant_id", nullable = false)
    private Restaurant restaurant;
    
    @ManyToOne(fetch = FetchType.LAZY)
    @JoinColumn(name = "delivery_agent_id")
    private User deliveryAgent;
    
    @Enumerated(EnumType.STRING)
    private OrderStatus status = OrderStatus.PLACED;
    
    @OneToMany(mappedBy = "order", cascade = CascadeType.ALL)
    private List<OrderItem> items = new ArrayList<>();
    
    private BigDecimal itemsTotal;
    private BigDecimal deliveryFee;
    private BigDecimal taxAmount;
    private BigDecimal totalAmount;
    
    private LocalDateTime placedAt;
    private LocalDateTime confirmedAt;
    private LocalDateTime readyAt;
    private LocalDateTime deliveredAt;
    
    // Getters, setters, constructors
}
```

### 4.3 Security Configuration

```java
@Configuration
@EnableWebSecurity
@EnableMethodSecurity
public class SecurityConfig {
    
    @Autowired
    private JwtAuthenticationFilter jwtAuthFilter;
    
    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity http) throws Exception {
        http
            .csrf(csrf -> csrf.disable())
            .cors(cors -> cors.configurationSource(corsConfigurationSource()))
            .sessionManagement(session -> 
                session.sessionCreationPolicy(SessionCreationPolicy.STATELESS))
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/v1/auth/**", "/ws/**").permitAll()
                .requestMatchers("/api/v1/customer/**").hasRole("CUSTOMER")
                .requestMatchers("/api/v1/restaurant/**").hasRole("RESTAURANT_OWNER")
                .requestMatchers("/api/v1/delivery/**").hasRole("DELIVERY_AGENT")
                .requestMatchers("/api/v1/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthFilter, UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
    
    @Bean
    public PasswordEncoder passwordEncoder() {
        return new BCryptPasswordEncoder();
    }
    
    @Bean
    public CorsConfigurationSource corsConfigurationSource() {
        CorsConfiguration configuration = new CorsConfiguration();
        configuration.setAllowedOrigins(Arrays.asList("http://localhost:3000", "https://yourdomain.com"));
        configuration.setAllowedMethods(Arrays.asList("GET", "POST", "PUT", "DELETE", "OPTIONS"));
        configuration.setAllowedHeaders(Arrays.asList("*"));
        configuration.setAllowCredentials(true);
        
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", configuration);
        return source;
    }
}
```

### 4.4 JWT Implementation

```java
@Component
public class JwtTokenProvider {
    
    @Value("${jwt.secret}")
    private String jwtSecret;
    
    @Value("${jwt.expiration}")
    private long jwtExpirationMs;
    
    public String generateToken(UserDetails userDetails) {
        Map<String, Object> claims = new HashMap<>();
        User user = (User) userDetails;
        claims.put("role", user.getRole().name());
        claims.put("userId", user.getId());
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(userDetails.getUsername())
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + jwtExpirationMs))
            .signWith(SignatureAlgorithm.HS512, jwtSecret)
            .compact();
    }
    
    public String getUsernameFromToken(String token) {
        return Jwts.parser()
            .setSigningKey(jwtSecret)
            .parseClaimsJws(token)
            .getBody()
            .getSubject();
    }
    
    public boolean validateToken(String token) {
        try {
            Jwts.parser().setSigningKey(jwtSecret).parseClaimsJws(token);
            return true;
        } catch (Exception e) {
            return false;
        }
    }
}
```

### 4.5 Order Service Implementation

```java
@Service
@Transactional
public class OrderService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private RestaurantRepository restaurantRepository;
    
    @Autowired
    private ApplicationEventPublisher eventPublisher;
    
    public OrderDTO createOrder(CreateOrderRequest request, Long customerId) {
        // 1. Validate restaurant
        Restaurant restaurant = restaurantRepository.findById(request.getRestaurantId())
            .orElseThrow(() -> new RestaurantNotFoundException("Restaurant not found"));
        
        if (!restaurant.getIsAcceptingOrders()) {
            throw new RestaurantNotAvailableException("Restaurant is not accepting orders");
        }
        
        // 2. Calculate totals
        BigDecimal itemsTotal = calculateItemsTotal(request.getItems());
        BigDecimal deliveryFee = calculateDeliveryFee(restaurant, request.getDeliveryAddress());
        BigDecimal taxAmount = itemsTotal.multiply(BigDecimal.valueOf(0.05)); // 5% tax
        BigDecimal total = itemsTotal.add(deliveryFee).add(taxAmount);
        
        // 3. Create order
        Order order = new Order();
        order.setOrderNumber(generateOrderNumber());
        order.setCustomer(userRepository.findById(customerId).orElseThrow());
        order.setRestaurant(restaurant);
        order.setStatus(OrderStatus.PLACED);
        order.setItemsTotal(itemsTotal);
        order.setDeliveryFee(deliveryFee);
        order.setTaxAmount(taxAmount);
        order.setTotalAmount(total);
        order.setPlacedAt(LocalDateTime.now());
        
        // 4. Add order items
        for (OrderItemRequest itemRequest : request.getItems()) {
            Product product = productRepository.findById(itemRequest.getProductId())
                .orElseThrow(() -> new ProductNotFoundException("Product not found"));
            
            OrderItem orderItem = new OrderItem();
            orderItem.setOrder(order);
            orderItem.setProduct(product);
            orderItem.setProductName(product.getName());
            orderItem.setQuantity(itemRequest.getQuantity());
            orderItem.setUnitPrice(product.getPrice());
            orderItem.setSubtotal(product.getPrice().multiply(BigDecimal.valueOf(itemRequest.getQuantity())));
            
            order.getItems().add(orderItem);
        }
        
        // 5. Save order
        Order savedOrder = orderRepository.save(order);
        
        // 6. Publish event
        eventPublisher.publishEvent(new OrderPlacedEvent(savedOrder.getId(), customerId));
        
        return OrderMapper.toDTO(savedOrder);
    }
    
    public void updateOrderStatus(Long orderId, OrderStatus newStatus, Long userId) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("Order not found"));
        
        OrderStatus oldStatus = order.getStatus();
        order.setStatus(newStatus);
        
        // Update timestamps based on status
        switch (newStatus) {
            case CONFIRMED:
                order.setConfirmedAt(LocalDateTime.now());
                break;
            case READY:
                order.setReadyAt(LocalDateTime.now());
                break;
            case DELIVERED:
                order.setDeliveredAt(LocalDateTime.now());
                break;
        }
        
        orderRepository.save(order);
        
        // Publish status change event
        eventPublisher.publishEvent(new OrderStatusChangedEvent(
            orderId, oldStatus, newStatus, userId
        ));
    }
    
    private String generateOrderNumber() {
        return "ORD-" + LocalDate.now().format(DateTimeFormatter.ofPattern("yyyyMMdd")) 
               + "-" + String.format("%04d", new Random().nextInt(10000));
    }
    
    private BigDecimal calculateDeliveryFee(Restaurant restaurant, Address address) {
        double distance = GeoUtils.calculateDistance(
            restaurant.getLatitude(), restaurant.getLongitude(),
            address.getLatitude(), address.getLongitude()
        );
        
        if (distance <= 2) return BigDecimal.valueOf(20);
        else if (distance <= 5) return BigDecimal.valueOf(40);
        else return BigDecimal.valueOf(60);
    }
}
```

### 4.6 Delivery Assignment Service

```java
@Service
public class DeliveryAssignmentService {
    
    @Autowired
    private OrderRepository orderRepository;
    
    @Autowired
    private UserRepository userRepository;
    
    @Autowired
    private DeliveryAssignmentRepository assignmentRepository;
    
    @Autowired
    private NotificationService notificationService;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * Smart algorithm to find and assign delivery agents
     * 1. Find available agents within 5km radius
     * 2. Sort by rating and current load
     * 3. Send notification to top 3 agents
     * 4. First to accept gets the order
     */
    public void findAndAssignDeliveryAgent(Long orderId) {
        Order order = orderRepository.findById(orderId)
            .orElseThrow(() -> new OrderNotFoundException("Order not found"));
        
        Restaurant restaurant = order.getRestaurant();
        
        // 1. Find available agents within 5km
        List<User> availableAgents = findNearbyAvailableAgents(
            restaurant.getLatitude(), 
            restaurant.getLongitude(),
            5.0 // radius in km
        );
        
        if (availableAgents.isEmpty()) {
            // Expand search radius to 10km
            availableAgents = findNearbyAvailableAgents(
                restaurant.getLatitude(), 
                restaurant.getLongitude(),
                10.0
            );
        }
        
        // 2. Sort by rating and current active deliveries
        availableAgents = sortAgentsByPriority(availableAgents);
        
        // 3. Take top 3 agents and send notification
        List<User> topAgents = availableAgents.stream()
            .limit(3)
            .collect(Collectors.toList());
        
        for (User agent : topAgents) {
            DeliveryAssignment assignment = new DeliveryAssignment();
            assignment.setOrder(order);
            assignment.setDeliveryAgent(agent);
            assignment.setStatus(AssignmentStatus.PENDING);
            assignment.setAssignedAt(LocalDateTime.now());
            
            assignmentRepository.save(assignment);
            
            // Send push notification
            notificationService.sendDeliveryRequest(agent.getId(), orderId);
        }
        
        // 4. Store in Redis with 2-minute expiry for quick acceptance
        redisTemplate.opsForValue().set(
            "order:pending:" + orderId, 
            topAgents.stream().map(User::getId).collect(Collectors.toList()),
            2, 
            TimeUnit.MINUTES
        );
    }
    
    private List<User> findNearbyAvailableAgents(Double lat, Double lng, Double radiusKm) {
        // Use PostGIS earth_distance function or custom query
        return userRepository.findAvailableAgentsWithinRadius(lat, lng, radiusKm);
    }
    
    private List<User> sortAgentsByPriority(List<User> agents) {
        return agents.stream()
            .sorted((a1, a2) -> {
                // Priority 1: Current active deliveries (less is better)
                int activeDeliveries1 = getActiveDeliveryCount(a1.getId());
                int activeDeliveries2 = getActiveDeliveryCount(a2.getId());
                
                if (activeDeliveries1 != activeDeliveries2) {
                    return Integer.compare(activeDeliveries1, activeDeliveries2);
                }
                
                // Priority 2: Rating (higher is better)
                Double rating1 = getAgentRating(a1.getId());
                Double rating2 = getAgentRating(a2.getId());
                return Double.compare(rating2, rating1);
            })
            .collect(Collectors.toList());
    }
    
    @Transactional
    public void acceptDelivery(Long orderId, Long agentId) {
        // Atomic operation: check if order still available
        DeliveryAssignment assignment = assignmentRepository
            .findByOrderIdAndAgentIdAndStatus(orderId, agentId, AssignmentStatus.PENDING)
            .orElseThrow(() -> new AssignmentNotFoundException("Assignment not found or already accepted"));
        
        // Update assignment
        assignment.setStatus(AssignmentStatus.ACCEPTED);
        assignment.setAcceptedAt(LocalDateTime.now());
        assignmentRepository.save(assignment);
        
        // Update order
        Order order = assignment.getOrder();
        order.setDeliveryAgent(assignment.getDeliveryAgent());
        order.setStatus(OrderStatus.ASSIGNED);
        orderRepository.save(order);
        
        // Reject all other pending assignments for this order
        assignmentRepository.findByOrderIdAndStatus(orderId, AssignmentStatus.PENDING)
            .forEach(a -> {
                if (!a.getId().equals(assignment.getId())) {
                    a.setStatus(AssignmentStatus.CANCELLED);
                    assignmentRepository.save(a);
                }
            });
        
        // Notify customer
        notificationService.sendDeliveryAssignedNotification(order.getCustomer().getId(), orderId, agentId);
        
        // Remove from Redis
        redisTemplate.delete("order:pending:" + orderId);
    }
    
    public void rejectDelivery(Long orderId, Long agentId, String reason) {
        DeliveryAssignment assignment = assignmentRepository
            .findByOrderIdAndAgentIdAndStatus(orderId, agentId, AssignmentStatus.PENDING)
            .orElseThrow(() -> new AssignmentNotFoundException("Assignment not found"));
        
        assignment.setStatus(AssignmentStatus.REJECTED);
        assignment.setRejectedAt(LocalDateTime.now());
        assignment.setRejectionReason(reason);
        assignmentRepository.save(assignment);
        
        // Check if any other agents are pending
        List<DeliveryAssignment> pendingAssignments = assignmentRepository
            .findByOrderIdAndStatus(orderId, AssignmentStatus.PENDING);
        
        if (pendingAssignments.isEmpty()) {
            // No agents available, expand search
            findAndAssignDeliveryAgent(orderId);
        }
    }
    
    private int getActiveDeliveryCount(Long agentId) {
        return assignmentRepository.countByAgentIdAndStatusIn(
            agentId, 
            Arrays.asList(AssignmentStatus.ACCEPTED, AssignmentStatus.PICKED_UP)
        );
    }
    
    private Double getAgentRating(Long agentId) {
        return reviewRepository.getAverageRatingForAgent(agentId).orElse(4.0);
    }
}
```

### 4.7 Location Tracking Service

```java
@Service
public class LocationTrackingService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Autowired
    private AgentLocationRepository locationRepository;
    
    @Autowired
    private SimpMessagingTemplate messagingTemplate;
    
    public void updateAgentLocation(Long agentId, Double lat, Double lng, Double accuracy) {
        // 1. Store in Redis for real-time tracking (5-minute TTL)
        AgentLocation location = new AgentLocation();
        location.setAgentId(agentId);
        location.setLatitude(lat);
        location.setLongitude(lng);
        location.setAccuracyMeters(accuracy);
        location.setRecordedAt(LocalDateTime.now());
        
        redisTemplate.opsForValue().set(
            "agent:location:" + agentId,
            location,
            5,
            TimeUnit.MINUTES
        );
        
        // 2. Persist to DB every 5th update (to reduce DB load)
        Long updateCount = redisTemplate.opsForValue().increment("agent:location:count:" + agentId);
        if (updateCount % 5 == 0) {
            locationRepository.save(toEntity(location));
        }
        
        // 3. Broadcast to customers tracking this agent's delivery
        List<Long> trackingCustomers = getCustomersTrackingAgent(agentId);
        for (Long customerId : trackingCustomers) {
            messagingTemplate.convertAndSendToUser(
                customerId.toString(),
                "/queue/location",
                LocationUpdateDTO.from(location)
            );
        }
    }
    
    public AgentLocation getCurrentLocation(Long agentId) {
        // Try Redis first
        AgentLocation location = (AgentLocation) redisTemplate
            .opsForValue()
            .get("agent:location:" + agentId);
        
        if (location != null) {
            return location;
        }
        
        // Fallback to DB
        return locationRepository.findLatestByAgentId(agentId)
            .orElseThrow(() -> new LocationNotFoundException("Location not found"));
    }
    
    private List<Long> getCustomersTrackingAgent(Long agentId) {
        // Find active orders for this agent
        return orderRepository.findActiveOrderCustomersByAgentId(agentId);
    }
}
```

---

## 5. Frontend Implementation

### 5.1 Project Structure

```
food-delivery-frontend/
â”œâ”€â”€ public/
â”‚   â”œâ”€â”€ index.html
â”‚   â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ App.js
â”‚   â”œâ”€â”€ index.js
â”‚   â”œâ”€â”€ api/
â”‚   â”‚   â”œâ”€â”€ axios.js
â”‚   â”‚   â”œâ”€â”€ authApi.js
â”‚   â”‚   â”œâ”€â”€ orderApi.js
â”‚   â”‚   â”œâ”€â”€ restaurantApi.js
â”‚   â”‚   â””â”€â”€ deliveryApi.js
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ common/
â”‚   â”‚   â”‚   â”œâ”€â”€ Header.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Loader.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ Modal.jsx
â”‚   â”‚   â”‚   â””â”€â”€ ProtectedRoute.jsx
â”‚   â”‚   â”œâ”€â”€ customer/
â”‚   â”‚   â”‚   â”œâ”€â”€ RestaurantCard.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ ProductCard.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CartDrawer.jsx
â”‚   â”‚   â”‚   â””â”€â”€ OrderTracking.jsx
â”‚   â”‚   â”œâ”€â”€ restaurant/
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderTable.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ OrderCard.jsx
â”‚   â”‚   â”‚   â””â”€â”€ MenuManagement.jsx
â”‚   â”‚   â””â”€â”€ delivery/
â”‚   â”‚       â”œâ”€â”€ TaskCard.jsx
â”‚   â”‚       â”œâ”€â”€ NavigationMap.jsx
â”‚   â”‚       â””â”€â”€ EarningsCard.jsx
â”‚   â”œâ”€â”€ pages/
â”‚   â”‚   â”œâ”€â”€ LoginPage.jsx
â”‚   â”‚   â”œâ”€â”€ customer/
â”‚   â”‚   â”‚   â”œâ”€â”€ HomePage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ RestaurantPage.jsx
â”‚   â”‚   â”‚   â”œâ”€â”€ CheckoutPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ OrderTrackingPage.jsx
â”‚   â”‚   â”œâ”€â”€ restaurant/
â”‚   â”‚   â”‚   â”œâ”€â”€ DashboardPage.jsx
â”‚   â”‚   â”‚   â””â”€â”€ MenuPage.jsx
â”‚   â”‚   â””â”€â”€ delivery/
â”‚   â”‚       â”œâ”€â”€ TasksPage.jsx
â”‚   â”‚       â””â”€â”€ NavigationPage.jsx
â”‚   â”œâ”€â”€ context/
â”‚   â”‚   â”œâ”€â”€ AuthContext.jsx
â”‚   â”‚   â”œâ”€â”€ CartContext.jsx
â”‚   â”‚   â””â”€â”€ WebSocketContext.jsx
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useAuth.js
â”‚   â”‚   â”œâ”€â”€ useCart.js
â”‚   â”‚   â”œâ”€â”€ useWebSocket.js
â”‚   â”‚   â””â”€â”€ useGeolocation.js
â”‚   â”œâ”€â”€ utils/
â”‚   â”‚   â”œâ”€â”€ formatters.js
â”‚   â”‚   â”œâ”€â”€ validators.js
â”‚   â”‚   â””â”€â”€ constants.js
â”‚   â””â”€â”€ styles/
â”‚       â””â”€â”€ global.css
â”œâ”€â”€ package.json
â””â”€â”€ tailwind.config.js
```

### 5.2 Core Components

**ProtectedRoute.jsx**
```javascript
import { Navigate, Outlet, useLocation } from 'react-router-dom';
import { useAuth } from '../hooks/useAuth';

export default function ProtectedRoute({ allowedRoles }) {
  const { user, role, loading } = useAuth();
  const location = useLocation();
  
  if (loading) {
    return <div className="flex justify-center items-center h-screen">
      <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-orange-500"></div>
    </div>;
  }
  
  if (!user) {
    return <Navigate to="/login" state={{ from: location }} replace />;
  }
  
  if (allowedRoles && !allowedRoles.includes(role)) {
    return <Navigate to="/unauthorized" replace />;
  }
  
  return <Outlet />;
}
```

**AuthContext.jsx**
```javascript
import { createContext, useState, useEffect } from 'react';
import { jwtDecode } from 'jwt-decode';
import { authApi } from '../api/authApi';

export const AuthContext = createContext();

export function AuthProvider({ children }) {
  const [user, setUser] = useState(null);
  const [role, setRole] = useState(null);
  const [loading, setLoading] = useState(true);
  
  useEffect(() => {
    const token = localStorage.getItem('token');
    if (token) {
      try {
        const decoded = jwtDecode(token);
        setUser(decoded);
        setRole(decoded.role);
      } catch (error) {
        localStorage.removeItem('token');
      }
    }
    setLoading(false);
  }, []);
  
  const login = async (email, password) => {
    try {
      const response = await authApi.login(email, password);
      const { token, role: userRole } = response.data;
      
      localStorage.setItem('token', token);
      const decoded = jwtDecode(token);
      setUser(decoded);
      setRole(userRole);
      
      return { success: true, role: userRole };
    } catch (error) {
      return { success: false, error: error.response?.data?.message || 'Login failed' };
    }
  };
  
  const logout = () => {
    localStorage.removeItem('token');
    setUser(null);
    setRole(null);
  };
  
  return (
    <AuthContext.Provider value={{ user, role, loading, login, logout }}>
      {children}
    </AuthContext.Provider>
  );
}
```

**WebSocketContext.jsx**
```javascript
import { createContext, useEffect, useState, useRef } from 'react';
import { useAuth } from '../hooks/useAuth';

export const WebSocketContext = createContext();

export function WebSocketProvider({ children }) {
  const [connected, setConnected] = useState(false);
  const [messages, setMessages] = useState([]);
  const wsRef = useRef(null);
  const { user } = useAuth();
  
  useEffect(() => {
    if (!user) return;
    
    const token = localStorage.getItem('token');
    const ws = new WebSocket(`wss://api.yourapp.com/ws?token=${token}`);
    
    ws.onopen = () => {
      console.log('WebSocket connected');
      setConnected(true);
    };
    
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      setMessages(prev => [...prev, data]);
      
      // Handle different message types
      switch (data.type) {
        case 'ORDER_STATUS_CHANGED':
          // Trigger notification or state update
          break;
        case 'DELIVERY_ASSIGNED':
          // Update UI
          break;
        case 'AGENT_LOCATION':
          // Update map
          break;
      }
    };
    
    ws.onerror = (error) => {
      console.error('WebSocket error:', error);
    };
    
    ws.onclose = () => {
      console.log('WebSocket disconnected');
      setConnected(false);
    };
    
    wsRef.current = ws;
    
    return () => {
      ws.close();
    };
  }, [user]);
  
  const sendMessage = (message) => {
    if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
      wsRef.current.send(JSON.stringify(message));
    }
  };
  
  return (
    <WebSocketContext.Provider value={{ connected, messages, sendMessage }}>
      {children}
    </WebSocketContext.Provider>
  );
}
```

### 5.3 Customer Interface

**HomePage.jsx**
```javascript
import { useState, useEffect } from 'react';
import { restaurantApi } from '../../api/restaurantApi';
import RestaurantCard from '../../components/customer/RestaurantCard';
import { Search, MapPin, Filter } from 'lucide-react';

export default function HomePage() {
  const [restaurants, setRestaurants] = useState([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedCuisine, setSelectedCuisine] = useState('all');
  
  useEffect(() => {
    loadRestaurants();
  }, [selectedCuisine]);
  
  const loadRestaurants = async () => {
    try {
      setLoading(true);
      const response = await restaurantApi.getNearbyRestaurants({
        latitude: 28.6139,
        longitude: 77.2090,
        cuisine: selectedCuisine !== 'all' ? selectedCuisine : null
      });
      setRestaurants(response.data);
    } catch (error) {
      console.error('Failed to load restaurants:', error);
    } finally {
      setLoading(false);
    }
  };
  
  const filteredRestaurants = restaurants.filter(restaurant =>
    restaurant.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    restaurant.cuisineType.toLowerCase().includes(searchQuery.toLowerCase())
  );
  
  return (
    <div className="min-h-screen bg-gray-50">
      {/* Header */}
      <div className="bg-white shadow-sm sticky top-0 z-10">
        <div className="max-w-7xl mx-auto px-4 py-4">
          <div className="flex items-center gap-2 mb-4">
            <MapPin className="text-orange-500" size={20} />
            <span className="font-medium">Delivering to: Home</span>
          </div>
          
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400" size={20} />
            <input
              type="text"
              placeholder="Search for restaurants or cuisines"
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500"
            />
          </div>
        </div>
      </div>
      
      {/* Filters */}
      <div className="max-w-7xl mx-auto px-4 py-4">
        <div className="flex gap-2 overflow-x-auto">
          {['all', 'Italian', 'Chinese', 'Indian', 'Mexican'].map(cuisine => (
            <button
              key={cuisine}
              onClick={() => setSelectedCuisine(cuisine)}
              className={`px-4 py-2 rounded-full whitespace-nowrap ${
                selectedCuisine === cuisine
                  ? 'bg-orange-500 text-white'
                  : 'bg-white text-gray-700 border border-gray-200'
              }`}
            >
              {cuisine === 'all' ? 'All' : cuisine}
            </button>
          ))}
        </div>
      </div>
      
      {/* Restaurant Grid */}
      <div className="max-w-7xl mx-auto px-4 py-6">
        {loading ? (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[1, 2, 3, 4, 5, 6].map(i => (
              <div key={i} className="bg-white rounded-lg shadow-sm h-64 animate-pulse" />
            ))}
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredRestaurants.map(restaurant => (
              <RestaurantCard key={restaurant.id} restaurant={restaurant} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
}
```

**OrderTracking.jsx**
```javascript
import { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { useWebSocket } from '../../hooks/useWebSocket';
import { orderApi } from '../../api/orderApi';
import { MapPin, Phone, Package, CheckCircle } from 'lucide-react';

export default function OrderTracking() {
  const { orderId } = useParams();
  const [order, setOrder] = useState(null);
  const [agentLocation, setAgentLocation] = useState(null);
  const { messages } = useWebSocket();
  
  useEffect(() => {
    loadOrderDetails();
  }, [orderId]);
  
  useEffect(() => {
    // Listen for WebSocket updates
    const locationUpdate = messages.find(
      m => m.type === 'AGENT_LOCATION' && m.orderId === parseInt(orderId)
    );
    if (locationUpdate) {
      setAgentLocation(locationUpdate.location);
    }
    
    const statusUpdate = messages.find(
      m => m.type === 'ORDER_STATUS_CHANGED' && m.orderId === parseInt(orderId)
    );
    if (statusUpdate) {
      setOrder(prev => ({ ...prev, status: statusUpdate.newStatus }));
    }
  }, [messages, orderId]);
  
  const loadOrderDetails = async () => {
    try {
      const response = await orderApi.getOrderById(orderId);
      setOrder(response.data);
    } catch (error) {
      console.error('Failed to load order:', error);
    }
  };
  
  const statusSteps = [
    { key: 'PLACED', label: 'Order Placed', icon: Package },
    { key: 'CONFIRMED', label: 'Confirmed', icon: CheckCircle },
    { key: 'PREPARING', label: 'Preparing', icon: Package },
    { key: 'READY', label: 'Ready', icon: CheckCircle },
    { key: 'PICKED_UP', label: 'Picked Up', icon: MapPin },
    { key: 'OUT_FOR_DELIVERY', label: 'On the Way', icon: MapPin },
    { key: 'DELIVERED', label: 'Delivered', icon: CheckCircle }
  ];
  
  const currentStepIndex = statusSteps.findIndex(s => s.key === order?.status);
  
  if (!order) {
    return <div className="flex justify-center items-center h-screen">Loading...</div>;
  }
  
  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      {/* Order Status Timeline */}
      <div className="bg-white p-6 mb-4">
        <h2 className="text-xl font-bold mb-6">Order #{order.orderNumber}</h2>
        
        <div className="relative">
          {statusSteps.map((step, index) => {
            const Icon = step.icon;
            const isCompleted = index <= currentStepIndex;
            const isCurrent = index === currentStepIndex;
            
            return (
              <div key={step.key} className="flex items-start mb-6 last:mb-0">
                <div className={`flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center ${
                  isCompleted ? 'bg-green-500' : 'bg-gray-200'
                }`}>
                  <Icon className="text-white" size={20} />
                </div>
                
                <div className="ml-4 flex-1">
                  <p className={`font-medium ${isCurrent ? 'text-orange-500' : 'text-gray-700'}`}>
                    {step.label}
                  </p>
                  {isCurrent && (
                    <p className="text-sm text-gray-500 mt-1">In progress...</p>
                  )}
                </div>
                
                {index < statusSteps.length - 1 && (
                  <div className={`absolute left-5 top-10 w-0.5 h-12 ${
                    index < currentStepIndex ? 'bg-green-500' : 'bg-gray-200'
                  }`} style={{ marginTop: `${index * 72}px` }} />
                )}
              </div>
            );
          })}
        </div>
      </div>
      
      {/* Delivery Agent Info */}
      {order.deliveryAgent && (
        <div className="bg-white p-6 mb-4">
          <h3 className="font-bold mb-4">Delivery Partner</h3>
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <div className="w-12 h-12 bg-gray-200 rounded-full"></div>
              <div>
                <p className="font-medium">{order.deliveryAgent.name}</p>
                <p className="text-sm text-gray-500">â˜… 4.8 (1.2k deliveries)</p>
              </div>
            </div>
            <button className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
              <Phone className="text-white" size={20} />
            </button>
          </div>
        </div>
      )}
      
      {/* Live Map (if agent location available) */}
      {agentLocation && (
        <div className="bg-white p-6">
          <h3 className="font-bold mb-4">Live Tracking</h3>
          <div className="h-64 bg-gray-200 rounded-lg flex items-center justify-center">
            <p className="text-gray-500">Map showing agent at: {agentLocation.latitude}, {agentLocation.longitude}</p>
          </div>
        </div>
      )}
    </div>
  );
}
```

### 5.4 Restaurant Interface

**DashboardPage.jsx**
```javascript
import { useState, useEffect } from 'react';
import { useWebSocket } from '../../hooks/useWebSocket';
import { orderApi } from '../../api/orderApi';
import OrderCard from '../../components/restaurant/OrderCard';

export default function DashboardPage() {
  const [orders, setOrders] = useState([]);
  const [filter, setFilter] = useState('PENDING');
  const { messages } = useWebSocket();
  
  useEffect(() => {
    loadOrders();
  }, [filter]);
  
  useEffect(() => {
    // Real-time order updates
    const newOrder = messages.find(m => m.type === 'NEW_ORDER');
    if (newOrder) {
      loadOrders();
      // Play notification sound
      new Audio('/notification.mp3').play();
    }
  }, [messages]);
  
  const loadOrders = async () => {
    try {
      const response = await orderApi.getRestaurantOrders({
        status: filter !== 'ALL' ? filter : null
      });
      setOrders(response.data);
    } catch (error) {
      console.error('Failed to load orders:', error);
    }
  };
  
  const handleStatusUpdate = async (orderId, newStatus) => {
    try {
      await orderApi.updateOrderStatus(orderId, newStatus);
      loadOrders();
    } catch (error) {
      console.error('Failed to update status:', error);
    }
  };
  
  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-7xl mx-auto px-4 py-6">
        <h1 className="text-3xl font-bold mb-6">Orders Dashboard</h1>
        
        {/* Filter Tabs */}